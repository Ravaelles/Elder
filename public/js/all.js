function EngineView(i,t){this.width=-1,this.height=-1,this.constructor=function(i,t){this.width=i,this.height=t},this.constructor(i,t),this.getType=function(){return this.type}}function buildStyleStringForImg(i,t,n,o,e,a){var s="position: relative; ";if(n)i.marginLeft=o.width()/2-e/2,i.marginTop=o.height()/2-a/2,(t._action===SPEAR_EQUIP||t._action===SPEAR_UNEQUIP)&&(i.marginTop-=18,i.marginLeft-=17);else{if(i.marginLeft=-e/2,i.marginTop=-a,t.isActionWalk()){if(t.isActionWithWeapon(WEAPON_SPEAR))var r=.25,m=.3;else var r=.38,m=.32;var _=a/5;t._dir===DIR_E?i.marginLeft+=e*r:t._dir===DIR_W?i.marginLeft+=-e*r:t._dir===DIR_SE?(i.marginLeft+=e*m,i.marginTop+=a*m):t._dir===DIR_SW?(i.marginLeft-=e*m,i.marginTop+=a*m):t._dir===DIR_NW?(i.marginLeft+=-e*m,i.marginTop+=-a*m+_):t._dir===DIR_NE&&(i.marginLeft+=e*m,i.marginTop+=-a*m+_)}(t._action===SPEAR_EQUIP||t._action===SPEAR_UNEQUIP)&&(t._dir===DIR_SE?(i.marginLeft-=14,i.marginTop+=8):t._dir===DIR_SW?i.marginLeft-=18.5:t._dir===DIR_NE?(i.marginLeft+=18,i.marginTop+=3.5):t._dir===DIR_NW?i.marginLeft+=15:t._dir===DIR_E?(i.marginLeft-=5,i.marginTop+=12):t._dir===DIR_W&&(i.marginLeft+=4))}return i.marginLeft+=t.positionPX,i.marginTop+=t.positionPY,i.marginLeft&&(s+="left:"+i.marginLeft+"px; "),i.marginTop&&(s+="top:"+i.marginTop+"px; ",s+="z-index: "+(i.marginTop+a)+"; "),s}function DIR_RANDOM(){return randElem(DIR_ALL)}function DIR_RANDOM_SOUTH(){return randElem([DIR_SW,DIR_SE])}function DIR_RANDOM_NORTH(){return randElem([DIR_NW,DIR_NE])}function Unit(i){this._id=null,this._sex=null,this._action=null,this._dir=null,this._type=null,this.staticImageDisplayMode=!1,this.marginLeft=0,this.marginTop=0,this.positionPX=0,this.positionPY=0,this._lastAnimationEndsAt=0,this._divSelector=null,this.constructor=function(i){var t;t="string"==typeof i?JSON.parse(i):i,this._id=t.id?t.id:__firstFreeUnitId++,this._sex=t.sex?"n"+t.sex.toLowerCase():MALE,this._action=t.action?t.action:ACTION_IDLE,this._dir=t.dir?t.dir:DIR_SE,this._type=t.type,this._type||(console.log("Empty unit type for unit:"),console.log(this),alert("Empty unit type passed for new unit")),allUnits[this._id]=this},this.constructor(i),this.display=function(i){function t(i,t){$("#unit-img-"+i).attr("src",t)}this.staticImageDisplayMode=i;var n=this.createImageElement(),o=n.imageElement,e=n.imagePath;this.staticImageDisplayMode||this.createImageWrapper();var a=new Image;return a.unitId=this._id,a.unit=this,a.imageIsLoaded=!1,a.onload=function(n){var a="<script>$('#unit-img-"+this.unitId+"').css('border', '1px solid rgba(255,0,0,0.2)')</script>";NaN+this.unitId+"').css('border', 'none'); }, 1000)</script>",$("#canvas-debug").html(a);var s=$("#unit-img-"+this.unitId).attr("src");if(t(this.unitId,s),!this.imageIsLoaded){var r=this.unit;this.imageIsLoaded=!0,this.src=e;var m=this.width,_=this.height,c=$("#unit-wrapper-"+this.unitId);c.html(o);var u=$("#unit-img-"+this.unitId);r._imageSelector=u,u.attr({imgwidth:m,imgheight:_}),u.css("z-index",r.positionPY);var d=buildStyleStringForImg(this,r,i,c,m,_);d&&u.attr("style",d)}},a.src=e,this},this._queueAnimations=[],this.queueAnimation=function(i,t,n){var o,e=this.timeSinceLastAnimationEndedAgo(),a=e>=-20;if(n||(n=WALK_ANIMATION_LENGTH),t||(t=0),a?(o=0,this._lastAnimationEndsAt=this.timeNow()+t+n):(o=-e,this._lastAnimationEndsAt+=t+o+n),a&&0===this._queueAnimations.length)this._runAnimationNow(i,t,n);else{var s={options:i,animationLength:n,delay:t};this._queueAnimations.push(s)}return this},this._runAnimationNow=function(i,t,n){var o=this;return setTimeout(function(){var t=i.callbackAnimationAfterStart;t&&t(o,i),o._animate(i),setTimeout(function(){var t=i.callbackAnimationEnded;t&&t(o),o.runNextQueuedAnimationIfNeeded()},n,o)},t),this},this.runNextQueuedAnimationIfNeeded=function(){var i=this._queueAnimations.shift();if(void 0!==i){var t=i.options,n=i.animationLength,o=i.delay;this._runAnimationNow(t,o,n)}},this._animate=function(i,t){t||(t=0),i||(i=[]);var n=i.callbackAnimationBeforeStart;n&&n(this);var o=this;return setTimeout(function(){o.handleOptions(i),o.display(o.staticImageDisplayMode)},t),this._lastAnimationStarted+=t,this},this.timeSinceLastAnimationEndedAgo=function(){return this.timeNow()-this._lastAnimationEndsAt},this.timeNow=function(){return(new Date).getTime()},this.animation=function(i,t,n){return i||(i={}),n||(n=1700),(!t||0>t)&&(t=0),this.queueAnimation(i,t,n),this},this.walk=function(i,t){var n=WALK_ANIMATION_LENGTH+ +(0===this._queueAnimations.length?WALK_ANIMATION_MODIFIER_WHEN_FIRST:0);this.timeSinceLastAnimationEndedAgo();return t||(t=0),i||(i=[]),i.callbackAnimationAfterStart=function(i,t){i.convertActionToWalk()},i.callbackAnimationEnded=function(i){i.handleWalkPositionChange(),0===i._queueAnimations.length&&(i.convertActionToIdle(),i._animate())},this.queueAnimation(i,t,n),this},this.convertActionToWalk=function(){return this._action=this._action.replaceAt(1,"b"),this},this.convertActionToIdle=function(){return this._action=this._action.replaceAt(1,"a"),this},this.handleWalkPositionChange=function(){var i=82,t=36,n=0,o=0;return this._dir===DIR_E?n+=i:this._dir===DIR_W?n-=i:this._dir===DIR_SE?(n+=t,o+=t):this._dir===DIR_SW?(n-=t,o+=t):this._dir===DIR_NW?(n-=t,o-=t):this._dir===DIR_NE&&(n+=t,o-=t),this.positionPX+=n,this.positionPY+=o,this},this.equipWeapon=function(i,t){var n={action:window[i+"_EQUIP"]};if(n.callbackAnimationEnded=function(t){t._action=window[i+"_IDLE"]},i===WEAPON_SPEAR)var o=1300;else var o=1300;return this.queueAnimation(n,t,o),this},this.positionRandomly=function(){return this.positionPX=rand(0,engineView.width),this.positionPY=rand(0,engineView.height),this},this.position=function(i,t){return i||t?(this.positionPX=i,this.positionPY=t,this):{x:this.positionPX,y:this.positionPY}},this.createImageElement=function(){var i="unit-img-"+this._id,t=this._id?"id='"+i+"'":"",n="";if(this.isStaticImage())var o=this._type.substring(7),e="/img/nature/"+o+"/"+rand(1,numOfImages[o]),a=e+".png";else{var e=BASE_IMG_DIR+"all/"+this._sex+this._type+this._action+"_"+this._dir,a=e+".gif";n="unit-alive"}var s="<img "+t+" class='"+n+"' src='"+a+"' />";return{imageElement:s,imagePath:a}},this.createImageWrapper=function(){var i="unit-wrapper-"+this._id;null!==this._divSelector?this._divSelector.html("<div class='engine-unit' id='"+i+"'></div>"):($("#canvas").append("<div class='engine-unit' id='"+i+"'></div>"),this._divSelector=$("#canvas #"+i))},this.handleOptions=function(i){return i&&("undefined"!=typeof i.action&&(this._action=i.action),"undefined"!=typeof i.sex&&(this._sex=i.sex),"undefined"!=typeof i.dir&&(this._dir=i.dir),"undefined"!=typeof i.type&&(this._type=i.type)),this},this.dirTowardEast=function(){return-1!==[DIR_E,DIR_SE,DIR_NE].indexOf(this._dir)},this.dirTowardWest=function(){return-1!==[DIR_W,DIR_NW,DIR_SW].indexOf(this._dir)},this.dirTowardNorth=function(){return-1!==[DIR_NW,DIR_NE].indexOf(this._dir)},this.dirTowardSouth=function(){return-1!==[DIR_SW,DIR_SE].indexOf(this._dir)},this.isStaticImage=function(){return null!==this._type&&stringStartsWith(this._type,"nature_")},this.isActionWalk=function(){return"b"===this._action.charAt(1)},this.isActionWithWeapon=function(i){return i===WEAPON_SPEAR?weaponLetter="g":weaponLetter="a",this._action.charAt(0)===weaponLetter.charAt(0)},this.dir=function(i){return void 0===i?this._dir:void(this._dir=i)},this.action=function(i){return void 0===i?this._action:void(this._action=i)}}function gameLog(i){$(".game-log p").css("opacity","0.7"),$(".game-log").prepend("<p style='display: none' class='game-log-invisible'><span class='dot'>â€¢</span> "+i+"</p>"),$(".game-log .game-log-invisible").slideDown(700)}function initializeWorldmapEvents(){$(".worldmap-location").mousedown(function(i){mapMouseDown(i),i.stopPropagation()}).mouseup(function(i){mapMouseUp(i),i.stopPropagation()}).mousemove(function(i){mapMouseMove(i),i.stopPropagation()}),$(".worldmap").mousedown(function(i){mapMouseDown(i)}).mouseup(function(i){mapMouseUp(i)}).mousemove(function(i){mapMouseMove(i)}).mousewheel(function(i){mapScroll(i)}).mouseleave(function(i){mapMouseLeave(i)}).contextmenu(function(i){})}function mapMouseDown(i){worldmap=$(".worldmap"),2===i.button&&console.log("Right click"),mousePreviousPosition=i,mouseIsClicked=!0,mouseHasMoved=!1}function mapMouseUp(i){mouseHasMoved||mapClick(i),mouseIsClicked=!1,mousePreviousPosition=null}function mapMouseMove(i){mouseIsClicked&&(mouseHasMoved=!0),mouseIsClicked&&null!=mousePreviousPosition&&(translationVector=moveMapImage(i),moveMapObjects(translationVector)),mousePreviousPosition=i}function mapScroll(i){var t=i.deltaY;t>=1?changeZoom(i,!1):-1>=t&&changeZoom(i,!0)}function mapMouseLeave(i){mouseIsClicked&&(mapMouseUp(i),mouseIsClicked=!1)}function mapClick(i){var t=getMapCoordinatesFromScreenClick(i);gameLog("<span>["+t.mapX+","+t.mapY+"]</span> is unknown wasteland, not very hospitable place.")}function getMapCoordinatesFromScreenClick(i){var t=i.pageX-WORLDMAP_CANVAS_MARGIN_LEFT,n=i.pageY-WORLDMAP_CANVAS_MARGIN_TOP,o=-1*worldmap.css("background-position-x").slice(0,-2),e=o*zoom,a=WORLDMAP_CANVAS_WIDTH*zoom,s=t/WORLDMAP_CANVAS_WIDTH,r=-1*worldmap.css("background-position-y").slice(0,-2),m=r*zoom,_=WORLDMAP_CANVAS_HEIGHT*zoom,c=n/WORLDMAP_CANVAS_HEIGHT,u=parseInt(e+s*a),d=parseInt(m+c*_);return{mapX:u,mapY:d}}function getCanvasCoordinatesFromMapCoordinates(i,t){return{canvasX:i/zoom-getMapOffsetPixelsX(),canvasY:t/zoom-getMapOffsetPixelsY()}}function initializeWorldmapLocations(){var i=$(".worldmap");recalculateWorldmapLocationVariables(),worldmapLocations.forEach(function(t,n){i.append(createHtmlFromLocationJson(t,n))})}function createHtmlFromLocationJson(i,t){var n=i._id,o=i.name+" "+JSON.stringify(i.location),e=WORLDMAP_LOCATION_SIZE,a=getCanvasCoordinatesFromMapCoordinates(i.location.x-e/2,i.location.y-e/2),s="top:"+a.canvasY+"px;left:"+a.canvasX+"px;width:"+e+"px;height:"+e+"px;";return'<div class="worldmap-location" id="worldmap-location-'+n+'" variableName="worldmapLocations" variableIndex="'+t+'" style="'+s+'"><label style="margin-top:'+WORLDMAP_LOCATION_LABEL_MARGIN_TOP+'px">'+o+"</label></div>"}function recalculateWorldmapLocationVariables(){WORLDMAP_LOCATION_SIZE=WORLDMAP_LOCATION_SIZE_MODIFIER/zoom,WORLDMAP_LOCATION_LABEL_MARGIN_TOP=WORLDMAP_LOCATION_SIZE_MODIFIER/zoom*.95}function moveMapImage(i){var t=i.pageX-mousePreviousPosition.pageX,n=i.pageY-mousePreviousPosition.pageY,o=worldmap.css("background-position-x"),e=worldmap.css("background-position-y");if(o=parseFloat(o.substr(0,o.length-2)),e=parseFloat(e.substr(0,e.length-2)),deltaImagePosX=t*MOUSE_DRAG_MODIFIER,deltaImagePosY=n*MOUSE_DRAG_MODIFIER,o+=deltaImagePosX,e+=deltaImagePosY,imagePosXWithScreenWidth=o-WORLDMAP_CANVAS_WIDTH,imagePosYWithScreenHeight=e-WORLDMAP_CANVAS_HEIGHT,o>0){var a=o;o=0,deltaImagePosX-=a-o}else if(imagePosXWithScreenWidth<=-WORLDMAP_WIDTH/zoom){var a=o;o=-WORLDMAP_WIDTH/zoom+WORLDMAP_CANVAS_WIDTH,deltaImagePosX-=a-o}if(e>0){var s=e;e=0,deltaImagePosY-=s-e}else if(imagePosYWithScreenHeight<=-WORLDMAP_HEIGHT/zoom){var s=e;e=-WORLDMAP_HEIGHT/zoom+WORLDMAP_CANVAS_HEIGHT,deltaImagePosY-=s-e}return setBackgroundImagePosition(o,e),{dx:deltaImagePosX,dy:deltaImagePosY}}function moveMapObjects(i){var t=$(".worldmap-location");$.each(t,function(t,n){var o=$("#"+n.id);o.css("top",parseFloat(o.css("top"))+i.dy),o.css("left",parseFloat(o.css("left"))+i.dx)})}function setBackgroundImagePosition(i,t){worldmap.css("background-position-x",i+"px"),worldmap.css("background-position-y",t+"px")}function initializeWorldmapZoom(){currentMapImageWidth=WORLDMAP_IMAGE_INITIAL_WIDTH,currentMapImageHeight=currentMapImageWidth*WORLDMAP_CANVAS_WIDTH/WORLDMAP_CANVAS_HEIGHT,zoom=WORLDMAP_WIDTH/currentMapImageWidth}function changeZoom(i,t){oldMapImageWidth=currentMapImageWidth,oldZoom=zoom,t?currentMapImageWidth-=zoomStep:currentMapImageWidth+=zoomStep,zoom=WORLDMAP_WIDTH/currentMapImageWidth;var n=MIN_ZOOM_VALUE>zoom,o=WORLDMAP_CANVAS_WIDTH>currentMapImageWidth;return n||o?revertZoom():(console.log("zoom: "+zoom+" / map width: "+currentMapImageWidth),$(".worldmap").css("background-size",currentMapImageWidth+"px"),void changeZoom_updateMapLocation())}function revertZoom(){currentMapImageWidth=oldMapImageWidth,zoom=oldZoom}function getMapOffsetPixelsX(){return-1*getWorldmap().css("background-position-x").slice(0,-2)}function getMapOffsetPixelsY(){return-1*getWorldmap().css("background-position-y").slice(0,-2)}function changeZoom_updateMapLocation(){recalculateWorldmapLocationVariables();var i=$(".worldmap-location");$.each(i,function(i,t){var n=$("#"+t.id),o=n.attr("variableName"),e=n.attr("variableIndex"),a=window[o][e];n.css("width",WORLDMAP_LOCATION_SIZE+"px"),n.css("height",WORLDMAP_LOCATION_SIZE+"px");var s=getCanvasCoordinatesFromMapCoordinates(a.location.x-WORLDMAP_LOCATION_SIZE/2,a.location.y-WORLDMAP_LOCATION_SIZE/2);n.css("left",s.canvasX),n.css("top",s.canvasY)}),$(".worldmap-location label").css("margin-top",WORLDMAP_LOCATION_LABEL_MARGIN_TOP+"px")}function getWorldmap(){return null!=worldmap?worldmap:worldmap=$(".worldmap")}function initializeWorldmap(){var i=$(".worldmap");i.css("background-image",'url("/img/map/map.jpg")'),i.css("background-size",currentMapImageWidth+"px"),i.css("background-position-x","-"+WORLDMAP_INITIAL_VIEW_X+"px"),i.css("background-position-y","-"+WORLDMAP_INITIAL_VIEW_Y+"px")}ACTION_IDLE="aa",ACTION_WALK="ab",ACTION_CLIMB_UP="ae",ACTION_PICK_UP="ak",ACTION_USE="al",ACTION_DODGE="an",ACTION_HIT="ao",ACTION_HIT2="ap",ACTION_HAND_COMBAT="aq",ACTION_KICK="ar",ACTION_THROW="as",ACTION_RUN="at",ACTION_RANDOM_STATIC="RANDOM_STATIC",SPEAR_IDLE="ga",SPEAR_WALK="gb",SPEAR_EQUIP="gc",SPEAR_UNEQUIP="gd",SPEAR_DODGE="ge",SPEAR_THRUST="gf",SPEAR_THROW="gm",SPEAR_RANDOM="RANDOM_SPEAR",WEAPON_SPEAR="SPEAR",WEAPON_10MM_PISTOL="10MM",DIR_W="w",DIR_E="e",DIR_NW="nw",DIR_NE="ne",DIR_SW="sw",DIR_SE="se",DIR_ALL=[DIR_W,DIR_E,DIR_NW,DIR_NE,DIR_SW,DIR_SE],WARRIOR_MALE="warr",WARRIOR_FEMALE="prim",SEX_GIRL="/img/special/sex-girl.png",NATURE_TREE="nature_tree",NATURE_GRASS="nature_grass",MALE="nm",FEMALE="nf";var BASE_IMG_DIR="/img/critter/",WALK_ANIMATION_LENGTH=800,WALK_ANIMATION_MODIFIER_WHEN_FIRST=100,allUnits=[],numOfImages=[];numOfImages.grass=5,numOfImages.misc=5,numOfImages.tree=6,__firstFreeUnitId=100;var mouseIsClicked=!1,mousePreviousPosition=null,mouseHasMoved=!1,WORLDMAP_LOCATION_SIZE_MODIFIER=35,WORLDMAP_LOCATION_SIZE=null,WORLDMAP_LOCATION_LABEL_MARGIN_TOP=null,MOUSE_DRAG_MODIFIER=1,WORLDMAP_IMAGE_INITIAL_WIDTH=3500,WORLDMAP_INITIAL_VIEW_X=100,WORLDMAP_INITIAL_VIEW_Y=100,MIN_ZOOM_VALUE=.58,zoom=1,zoomStep=150,currentMapImageWidth=null,currentMapImageHeight=null,oldMapImageWidth=null,oldZoom=null,WORLDMAP_WIDTH=3500,WORLDMAP_HEIGHT=3500,WORLDMAP_CANVAS_WIDTH=null,WORLDMAP_CANVAS_HEIGHT=null,WORLDMAP_CANVAS_MARGIN_LEFT=$(".sidebar").width(),WORLDMAP_CANVAS_MARGIN_TOP=$(".main-header").height(),worldmap=null;window.initQueue.push(function(){setTimeout(function(){WORLDMAP_CANVAS_WIDTH=$(".worldmap").width(),WORLDMAP_CANVAS_HEIGHT=$(".content-wrapper").height(),initializeWorldmapZoom(),initializeWorldmap(),initializeWorldmapLocations(),initializeWorldmapEvents()},80)});