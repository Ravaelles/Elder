{"version":3,"sources":["project.js","engine-view.js","unit-extra.js","unit.js","worldmap-auxiliary.js","worldmap-coordinates.js","worldmap-element.js","worldmap-events.js","worldmap-locations.js","worldmap-messages.js","worldmap-move.js","worldmap-object.js","worldmap-objects.js","worldmap-paint.js","worldmap-view.js","worldmap-zoom.js","worldmap.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7jBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACtGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"game.min.js","sourcesContent":["// =========================================================\r\n// === GENERIC =============================================\r\n// =========================================================\r\n\r\n/**\r\n * Shows popup message with OK|Cancel buttons. Best to use before deleting objects, on Delete button.\r\n * @param {type} message\r\n * @returns {Boolean}\r\n */\r\nfunction confirmDelete(message, disallowPleaseWaitOverlay) {\r\n    if (!message) {\r\n        message = \"Are you sure you want to delete?\";\r\n    }\r\n\r\n    if (confirm(message)) {\r\n        if (!disallowPleaseWaitOverlay) {\r\n            showPleaseWait();\r\n        }\r\n        return true;\r\n    }\r\n    else {\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Displays overlay with \"Please wait\" text. Based on bootstrap modal. Contains animated progress bar.\r\n */\r\nfunction showPleaseWait() {\r\n    var modalLoading = '<div class=\"modal\" id=\"pleaseWaitDialog\" data-backdrop=\"static\" data-keyboard=\"false role=\"dialog\">\\\r\n        <div class=\"modal-dialog\">\\\r\n            <div class=\"modal-content\">\\\r\n                <div class=\"modal-header\">\\\r\n                    <h4 class=\"modal-title\">Please wait...</h4>\\\r\n                </div>\\\r\n                <div class=\"modal-body\">\\\r\n                    <div class=\"progress\">\\\r\n                      <div class=\"progress-bar progress-bar-success progress-bar-striped active\" role=\"progressbar\"\\\r\n                      aria-valuenow=\"100\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width:100%; height: 40px\">\\\r\n                      </div>\\\r\n                    </div>\\\r\n                </div>\\\r\n            </div>\\\r\n        </div>\\\r\n    </div>';\r\n    $(document.body).append(modalLoading);\r\n    $(\"#pleaseWaitDialog\").modal(\"show\");\r\n}\r\n\r\n/**\r\n * Hides \"Please wait\" overlay. See function showPleaseWait().\r\n */\r\nfunction hidePleaseWait() {\r\n    $(\"#pleaseWaitDialog\").modal(\"hide\");\r\n}\r\n\r\nfunction scrollToElement(selector, miliseconds) {\r\n    if (!miliseconds) {\r\n        miliseconds = 1500;\r\n    }\r\n    $('html, body').animate({\r\n        scrollTop: $(selector).offset().top\r\n    }, miliseconds);\r\n}\r\n\r\nfunction appendErrorToBody(message) {\r\n    $(document.body).append(\"<div style='background-color: #a22l color: white;'>\" + message + \"</div>\");\r\n}\r\n\r\nfunction setCookie(cookieName, value, expireSecond) {\r\n    var d = new Date();\r\n    d.setTime(d.getTime() + (expireSecond * 1000));\r\n    var expires = \"expires=\" + d.toGMTString();\r\n    document.cookie = cookieName + \"=\" + value + \"; \" + expires;\r\n}\r\n\r\nfunction getCookie(cookieName) {\r\n    var name = cookieName + \"=\";\r\n    var ca = document.cookie.split(';');\r\n    for (var i = 0; i < ca.length; i++) {\r\n        var c = ca[i];\r\n        while (c.charAt(0) == ' ')\r\n            c = c.substring(1);\r\n        if (c.indexOf(name) == 0) {\r\n            return c.substring(name.length, c.length);\r\n        }\r\n    }\r\n    return \"\";\r\n}\r\n\r\nfunction rand(min, max) {\r\n    return Math.floor((Math.random() * max) + min);\r\n}\r\n\r\nfunction randArray(arr) {\r\n    return arr[Math.floor(Math.random() * arr.length)];\r\n}\r\n\r\nfunction randElem(arr) {\r\n    return arr[Math.floor(Math.random() * arr.length)];\r\n}\r\n\r\nfunction stringStartsWith(string, prefix) {\r\n    return string.lastIndexOf(prefix, 0) === 0;\r\n}\r\n\r\nString.prototype.replaceAt = function (index, character) {\r\n    return this.substr(0, index) + character + this.substr(index + character.length);\r\n}\r\n\r\n// =========================================================\r\n// ===== SPECIFIC ==========================================\r\n// =========================================================\r\n\r\nfunction typeSounds() {\r\n    $('input').keyup(function (e) {\r\n        playTypeSound();\r\n    });\r\n    $(\"label\").click(function () {\r\n        playTypeSound();\r\n    });\r\n    $(\"button\").click(function () {\r\n        playTypeSound();\r\n    });\r\n    $(\".create-account-button\").click(function () {\r\n        playTypeSound();\r\n    });\r\n}\r\n\r\nfunction playTypeSound() {\r\n    soundIndex = Math.floor((Math.random() * 5) + 1);\r\n    $(document.body).append('<audio controls autoplay style=\"display: none\" id=\"audio\"><source src=\"/sound/terminal/type' + soundIndex + '.mp3\" type=\"audio/mpeg\"></audio>');\r\n}\r\n","function EngineView(width, height) {\r\n\r\n    this.width = -1;\r\n    this.height = -1;\r\n\r\n    // =========================================================================\r\n\r\n    this.constructor = function (width, height) {\r\n        this.width = width;\r\n        this.height = height;\r\n    };\r\n    this.constructor(width, height);\r\n\r\n    // =========================================================================\r\n\r\n    this.getType = function () {\r\n        return this.type;\r\n    };\r\n\r\n}","function buildStyleStringForImg(image, unit, staticImageMode, imageWrapperSelector, width, height) {\r\n    var styleString = \"position: relative; \";\r\n\r\n    // =========================================================================\r\n    // Handle static mode (just ui animation) or regular, engine mode\r\n    if (staticImageMode) {\r\n        image.marginLeft = imageWrapperSelector.width() / 2 - width / 2;\r\n        image.marginTop = imageWrapperSelector.height() / 2 - height / 2;\r\n\r\n        if (unit._action === SPEAR_EQUIP || unit._action === SPEAR_UNEQUIP) {\r\n            image.marginTop -= 18;\r\n            image.marginLeft -= 17;\r\n        }\r\n    }\r\n    else {\r\n        image.marginLeft = -width / 2;\r\n        image.marginTop = -height;\r\n\r\n        // =========================================================================\r\n        // Alter WALK animations\r\n        if (unit.isActionWalk()) {\r\n\r\n            // Define horizontal movement factor\r\n            if (unit.isActionWithWeapon(WEAPON_SPEAR)) {\r\n                var walkFactor = 0.25; // Spear\r\n                var diagonalWalkFactor = 0.3;\r\n            }\r\n            else {\r\n                var walkFactor = 0.38; // Walk\r\n                var diagonalWalkFactor = 0.32;\r\n            }\r\n\r\n            // Define diagonal movement favtor\r\n            var walkToNorthMarginTopBonus = height / 5;\r\n\r\n            if (unit._dir === DIR_E) {\r\n                image.marginLeft += width * walkFactor;\r\n            }\r\n            else if (unit._dir === DIR_W) {\r\n                image.marginLeft += (-width * walkFactor);\r\n            }\r\n            else if (unit._dir === DIR_SE) {\r\n                image.marginLeft += width * diagonalWalkFactor;\r\n                image.marginTop += height * diagonalWalkFactor;\r\n            }\r\n            else if (unit._dir === DIR_SW) {\r\n                image.marginLeft -= width * diagonalWalkFactor;\r\n                image.marginTop += height * diagonalWalkFactor;\r\n            }\r\n            else if (unit._dir === DIR_NW) {\r\n                image.marginLeft += (-width * diagonalWalkFactor);\r\n                image.marginTop += (-height * diagonalWalkFactor + walkToNorthMarginTopBonus);\r\n            }\r\n            else if (unit._dir === DIR_NE) {\r\n                image.marginLeft += width * diagonalWalkFactor;\r\n                image.marginTop += (-height * diagonalWalkFactor + walkToNorthMarginTopBonus);\r\n            }\r\n        }\r\n\r\n        // =========================================================================\r\n        // Alter SPEAR\r\n        if (unit._action === SPEAR_EQUIP || unit._action === SPEAR_UNEQUIP) {\r\n            if (unit._dir === DIR_SE) {\r\n                image.marginLeft -= 14;\r\n                image.marginTop += 8;\r\n            }\r\n            else if (unit._dir === DIR_SW) {\r\n                image.marginLeft -= 18.5;\r\n            }\r\n            else if (unit._dir === DIR_NE) {\r\n                image.marginLeft += 18;\r\n                image.marginTop += 3.5;\r\n            }\r\n            else if (unit._dir === DIR_NW) {\r\n                image.marginLeft += 15;\r\n            }\r\n            else if (unit._dir === DIR_E) {\r\n                image.marginLeft -= 5;\r\n                image.marginTop += 12;\r\n            }\r\n            else if (unit._dir === DIR_W) {\r\n                image.marginLeft += 4;\r\n            }\r\n        }\r\n    }\r\n\r\n    // =========================================================================\r\n    // Include position factor\r\n    image.marginLeft += unit.positionPX;\r\n    image.marginTop += unit.positionPY;\r\n\r\n    // =========================================================================\r\n    // Handle margin\r\n    if (image.marginLeft) {\r\n        styleString += \"left:\" + image.marginLeft + \"px; \"\r\n    }\r\n    if (image.marginTop) {\r\n        styleString += \"top:\" + image.marginTop + \"px; \"\r\n        styleString += \"z-index: \" + (image.marginTop + height) + \"; \"\r\n    }\r\n    //                styleString += \"border: 1px solid red !important; \";\r\n\r\n    return styleString;\r\n}\r\n\r\n// =========================================================================\r\n\r\n// Actions\r\nACTION_IDLE = \"aa\";\r\nACTION_WALK = \"ab\";\r\nACTION_CLIMB_UP = \"ae\";\r\nACTION_PICK_UP = \"ak\";\r\nACTION_USE = \"al\";\r\nACTION_DODGE = \"an\";\r\nACTION_HIT = \"ao\";\r\nACTION_HIT2 = \"ap\";\r\nACTION_HAND_COMBAT = \"aq\";\r\nACTION_KICK = \"ar\";\r\nACTION_THROW = \"as\";\r\nACTION_RUN = \"at\";\r\nACTION_RANDOM_STATIC = \"RANDOM_STATIC\";\r\n// =========================================================================\r\n// Spear actions\r\nSPEAR_IDLE = \"ga\";\r\nSPEAR_WALK = \"gb\";\r\nSPEAR_EQUIP = \"gc\";\r\nSPEAR_UNEQUIP = \"gd\";\r\nSPEAR_DODGE = \"ge\";\r\nSPEAR_THRUST = \"gf\";\r\nSPEAR_THROW = \"gm\";\r\nSPEAR_RANDOM = \"RANDOM_SPEAR\";\r\n\r\n// =========================================================================\r\n// Weapons\r\nWEAPON_SPEAR = \"SPEAR\";\r\nWEAPON_10MM_PISTOL = \"10MM\";\r\n\r\n// =========================================================================\r\n// Direction\r\nDIR_W = \"w\";\r\nDIR_E = \"e\";\r\nDIR_NW = \"nw\";\r\nDIR_NE = \"ne\";\r\nDIR_SW = \"sw\";\r\nDIR_SE = \"se\";\r\nDIR_ALL = [DIR_W, DIR_E, DIR_NW, DIR_NE, DIR_SW, DIR_SE];\r\nfunction DIR_RANDOM() {\r\n    return randElem(DIR_ALL);\r\n}\r\nfunction DIR_RANDOM_SOUTH() {\r\n    return randElem([DIR_SW, DIR_SE]);\r\n}\r\nfunction DIR_RANDOM_NORTH() {\r\n    return randElem([DIR_NW, DIR_NE]);\r\n}\r\n\r\n// =========================================================================\r\n// People\r\nWARRIOR_MALE = \"warr\";\r\nWARRIOR_FEMALE = \"prim\";\r\nSEX_GIRL = \"/img/special/sex-girl.png\";\r\n// =========================================================================\r\n// Nature\r\nNATURE_TREE = \"nature_tree\";\r\nNATURE_GRASS = \"nature_grass\";\r\n// =========================================================================\r\n// Sex\r\nMALE = \"nm\";\r\nFEMALE = \"nf\";\r\n","/* global DIR_E, DIR_W, DIR_SW, DIR_NW, DIR_NE, DIR_SE, WEAPON_SPEAR, MALE, ACTION_IDLE, engineView */\r\n\r\nvar BASE_IMG_DIR = \"/img/critter/\";\r\nvar WALK_ANIMATION_LENGTH = 800;\r\nvar WALK_ANIMATION_MODIFIER_WHEN_FIRST = 100;\r\n\r\n// =========================================================================\r\n\r\nvar allUnits = [];\r\n\r\nvar numOfImages = [];\r\nnumOfImages['grass'] = 5;\r\nnumOfImages['misc'] = 5;\r\nnumOfImages['tree'] = 6;\r\n\r\n/**\r\n * This class represents animated unit/sprite/type to be displayed in the browser.\r\n * It's possible to change unit and animate it using animate() function. Commands can be chained like:\r\n * <p>var unit = new Unit(json).create()</p>\r\n *\r\n * Unit is identified by:\r\n * - sex - MALE/FEMALE\r\n * - dir - direction unit is facing - DIR_E, DIR_W, DIR_SE, DIR_SW, DIR_NE, DIR_NW 0\r\n * - action - currently executed action - choose one of many constans prefixed ACTION_, SPEAR_ etc\r\n * - type - Fallout identifier of the type in the gif, use constants lik WARRIOR_MALE, WARRIOR_FEMALE etc\r\n *\r\n * @param json json string that will be used to create object\r\n * @returns Unit\r\n */\r\nfunction Unit(json) {\r\n\r\n    this._id = null; // Unique identifier for the unit\r\n    this._sex = null; // Sex of this unit, use MALE or FEMALE\r\n    this._action = null; // Curenntly executed action, use ACTION_* and others\r\n    this._dir = null; // Direction unit is facing, use DIR_*\r\n    this._type = null; // Type of this unit e.g. WARRIOR_MALE, WARRIOR_FEMALE\r\n\r\n    this.staticImageDisplayMode = false;\r\n    this.marginLeft = 0;\r\n    this.marginTop = 0;\r\n\r\n    this.positionPX = 0; // Position X in pixels\r\n    this.positionPY = 0; // Position Y in pixels\r\n\r\n    this._lastAnimationEndsAt = 0;\r\n    this._divSelector = null;\r\n\r\n    // =========================================================================\r\n    // Constructor\r\n\r\n    this.constructor = function (json) {\r\n        var parameters;\r\n        if (typeof json === 'string') {\r\n            parameters = JSON.parse(json);\r\n        } else {\r\n            parameters = json;\r\n        }\r\n\r\n        this._id = parameters['id'] ? parameters['id'] : __firstFreeUnitId++;\r\n        this._sex = parameters['sex'] ? (\"n\" + parameters['sex'].toLowerCase()) : MALE;\r\n        this._action = parameters['action'] ? parameters['action'] : ACTION_IDLE;\r\n        this._dir = parameters['dir'] ? parameters['dir'] : DIR_SE;\r\n        this._type = parameters['type'];\r\n\r\n        if (!this._type) {\r\n            console.log(\"Empty unit type for unit:\");\r\n            console.log(this);\r\n            alert(\"Empty unit type passed for new unit\");\r\n        }\r\n\r\n        allUnits[this._id] = this;\r\n    };\r\n    this.constructor(json);\r\n\r\n    // =========================================================================\r\n    // Display\r\n\r\n    this.display = function (staticImageDisplayMode) {\r\n        this.staticImageDisplayMode = staticImageDisplayMode;\r\n\r\n        var imgObject = this.createImageElement();\r\n        var imageElement = imgObject['imageElement'];\r\n        var imagePath = imgObject['imagePath'];\r\n\r\n        // =========================================================================\r\n        // Create wrapper for the image if needed\r\n\r\n        if (!this.staticImageDisplayMode) {\r\n            this.createImageWrapper();\r\n        }\r\n\r\n        // =========================================================================\r\n\r\n        var imageObject = new Image();\r\n        imageObject.unitId = this._id;\r\n        imageObject.unit = this;\r\n        imageObject.imageIsLoaded = false;\r\n\r\n        function reloadImage(unitId, imgSource) {\r\n//            $('#unit-img-' + unitId).attr('src', imgSource);\r\n//            $('#unit-img-' + unitId).attr('src', \"/img/empty.jpg\");\r\n            $('#unit-img-' + unitId).attr('src', imgSource);\r\n        }\r\n\r\n        // Define image onload callback\r\n        imageObject.onload = function (event) {\r\n            var debugString = \"<script>$('#unit-img-\" + this.unitId + \"').css('border', '1px solid rgba(255,0,0,0.2)')</script>\";\r\n            +\"<script>setTimeout(function() { $('#unit-img-\" + this.unitId + \"').css('border', 'none'); }, 1000)</script>\";\r\n            $(\"#canvas-debug\").html(debugString);\r\n            var imgSource = $('#unit-img-' + this.unitId).attr('src');\r\n//            $('#unit-img-' + this.unitId).attr('src', '');\r\n            reloadImage(this.unitId, imgSource);\r\n\r\n            if (this.imageIsLoaded) {\r\n                return;\r\n            } else {\r\n\r\n                var unit = this.unit;\r\n                this.imageIsLoaded = true;\r\n                this.src = imagePath;\r\n                var width = this.width;\r\n                var height = this.height;\r\n\r\n                var imageWrapperSelector = $(\"#unit-wrapper-\" + this.unitId);\r\n\r\n                // Add ready <img src=> element to the div wrapper, thus displaying the animation\r\n                imageWrapperSelector.html(imageElement);\r\n\r\n                // Assign current image dimensions to the image element\r\n                var imageSelector = $(\"#unit-img-\" + this.unitId);\r\n                unit._imageSelector = imageSelector;\r\n                imageSelector.attr({\"imgwidth\": width, \"imgheight\": height});\r\n                imageSelector.css('z-index', unit.positionPY);\r\n\r\n                // =========================================================================\r\n                // Add extra STYLE to wrapping div if needed\r\n\r\n                var styleString = buildStyleStringForImg(\r\n                        this, unit, staticImageDisplayMode, imageWrapperSelector, width, height\r\n                        );\r\n                if (styleString) {\r\n                    imageSelector.attr(\"style\", styleString);\r\n                }\r\n            }\r\n        };\r\n\r\n        // Assign image url\r\n        imageObject.src = imagePath;\r\n\r\n        return this;\r\n    };\r\n\r\n    // =========================================================================\r\n    // Animation\r\n\r\n    this._queueAnimations = [];\r\n\r\n    this.queueAnimation = function (options, delay, animationLength) {\r\n        var startAnimatingUnitAfterTime;\r\n        var lastAnimationEndedAgo = this.timeSinceLastAnimationEndedAgo();\r\n        var canStartAnimationNow = lastAnimationEndedAgo >= -20;\r\n\r\n        if (!animationLength) {\r\n            animationLength = WALK_ANIMATION_LENGTH;\r\n//            animationLength = 800;\r\n//            animationLength = 2890;\r\n        }\r\n        if (!delay) {\r\n            delay = 0;\r\n        }\r\n\r\n        // =========================================================================\r\n        // Define time when next animation could be potentially executed\r\n\r\n        if (canStartAnimationNow) {\r\n            startAnimatingUnitAfterTime = 0;\r\n            this._lastAnimationEndsAt = this.timeNow() + delay + animationLength;\r\n        } else {\r\n            startAnimatingUnitAfterTime = -lastAnimationEndedAgo;\r\n            this._lastAnimationEndsAt += delay + startAnimatingUnitAfterTime + animationLength;\r\n//            this._lastAnimationEndsAt += delay + startAnimatingUnitAfterTime + animationLength;\r\n        }\r\n\r\n        // =========================================================================\r\n        // Either run an animation now or queue it\r\n\r\n        // Run now\r\n        if (canStartAnimationNow && this._queueAnimations.length === 0) {\r\n            this._runAnimationNow(options, delay, animationLength);\r\n        }\r\n\r\n        // Doing something else now, so queue it\r\n        else {\r\n            var animationObject = {\r\n                'options': options,\r\n                'animationLength': animationLength,\r\n                'delay': delay\r\n            };\r\n            this._queueAnimations.push(animationObject);\r\n        }\r\n\r\n        return this;\r\n    };\r\n\r\n    this._runAnimationNow = function (options, delay, animationLength) {\r\n        var unit = this;\r\n\r\n        setTimeout(function () {\r\n\r\n            // Run callback before the start of animation\r\n            var callbackAnimationAfterStart = options['callbackAnimationAfterStart'];\r\n            if (callbackAnimationAfterStart) {\r\n                callbackAnimationAfterStart(unit, options);\r\n            }\r\n\r\n            unit._animate(options);\r\n\r\n            // =========================================================================\r\n\r\n            setTimeout(function () {\r\n\r\n                // Run callback at the end of animation\r\n                var callbackAnimationEnded = options['callbackAnimationEnded'];\r\n                if (callbackAnimationEnded) {\r\n                    callbackAnimationEnded(unit);\r\n                }\r\n\r\n                // Run next animation in enqueued\r\n                unit.runNextQueuedAnimationIfNeeded();\r\n\r\n            }, animationLength, unit);\r\n        }, delay);\r\n\r\n        return this;\r\n    };\r\n\r\n    this.runNextQueuedAnimationIfNeeded = function () {\r\n        var nextAnimation = this._queueAnimations.shift();\r\n\r\n        if (nextAnimation !== undefined) {\r\n            var options = nextAnimation['options'];\r\n            var animationLength = nextAnimation['animationLength'];\r\n            var delay = nextAnimation['delay'];\r\n            this._runAnimationNow(options, delay, animationLength);\r\n        }\r\n    };\r\n\r\n    this._animate = function (options, afterTime) {\r\n        if (!afterTime) {\r\n            afterTime = 0;\r\n        }\r\n        if (!options) {\r\n            options = [];\r\n        }\r\n\r\n        // =========================================================================\r\n        // Animation started callback\r\n\r\n        var callbackAnimationBeforeStart = options['callbackAnimationBeforeStart'];\r\n        if (callbackAnimationBeforeStart) {\r\n            callbackAnimationBeforeStart(this);\r\n        }\r\n\r\n        // =========================================================================\r\n\r\n        var unit = this;\r\n        setTimeout(function () {\r\n            unit.handleOptions(options);\r\n            unit.display(unit.staticImageDisplayMode);\r\n        }, afterTime);\r\n\r\n        this._lastAnimationStarted += afterTime;\r\n\r\n        return this;\r\n    };\r\n\r\n    this.timeSinceLastAnimationEndedAgo = function () {\r\n        return this.timeNow() - this._lastAnimationEndsAt;\r\n    };\r\n\r\n    this.timeNow = function () {\r\n        return (new Date()).getTime();\r\n    };\r\n\r\n    // =========================================================================\r\n    // Animation generic\r\n\r\n    this.animation = function (options, delay, animationLength) {\r\n        if (!options) {\r\n            options = {};\r\n        }\r\n        if (!animationLength) {\r\n            animationLength = 1700;\r\n        }\r\n        if (!delay || delay < 0) {\r\n            delay = 0;\r\n        }\r\n\r\n        this.queueAnimation(options, delay, animationLength);\r\n\r\n        return this;\r\n    };\r\n\r\n    // Walk\r\n\r\n    this.walk = function (options, delay) {\r\n//        var walkAnimationTimespan = 990;\r\n        var walkAnimationTimespan = WALK_ANIMATION_LENGTH +\r\n                +(this._queueAnimations.length === 0 ? WALK_ANIMATION_MODIFIER_WHEN_FIRST : 0);\r\n//        console.l  og(this._queueAnimations.length + \" / \" + walkAnimationTimespan);\r\n//        console.l  og(walkAnimationTimespan);\r\n        var lastAnimationEnded = this.timeSinceLastAnimationEndedAgo();\r\n        var startAnimatingUnitAfterTime;\r\n\r\n        if (!delay) {\r\n            delay = 0;\r\n        }\r\n        if (!options) {\r\n            options = [];\r\n        }\r\n\r\n        // =========================================================================\r\n\r\n        options['callbackAnimationAfterStart'] = function (unit, options) {\r\n            unit.convertActionToWalk();\r\n        };\r\n\r\n        options['callbackAnimationEnded'] = function (unit) {\r\n            unit.handleWalkPositionChange();\r\n\r\n            if (unit._queueAnimations.length === 0) {\r\n                unit.convertActionToIdle();\r\n                unit._animate();\r\n            }\r\n        };\r\n\r\n        this.queueAnimation(options, delay, walkAnimationTimespan);\r\n\r\n        return this;\r\n    };\r\n\r\n    this.convertActionToWalk = function () {\r\n        this._action = this._action.replaceAt(1, \"b\");\r\n        return this;\r\n    };\r\n\r\n    this.convertActionToIdle = function () {\r\n        this._action = this._action.replaceAt(1, \"a\");\r\n        return this;\r\n    };\r\n\r\n    this.handleWalkPositionChange = function () {\r\n        var fullStep = 82;\r\n        var halfStep = 36;\r\n\r\n        var dx = 0;\r\n        var dy = 0;\r\n\r\n        if (this._dir === DIR_E) {\r\n            dx += fullStep;\r\n        } else if (this._dir === DIR_W) {\r\n            dx -= fullStep;\r\n        } else if (this._dir === DIR_SE) {\r\n            dx += halfStep;\r\n            dy += halfStep;\r\n        } else if (this._dir === DIR_SW) {\r\n            dx -= halfStep;\r\n            dy += halfStep;\r\n        } else if (this._dir === DIR_NW) {\r\n            dx -= halfStep;\r\n            dy -= halfStep;\r\n        } else if (this._dir === DIR_NE) {\r\n            dx += halfStep;\r\n            dy -= halfStep;\r\n        }\r\n\r\n        this.positionPX += dx;\r\n        this.positionPY += dy;\r\n\r\n        return this;\r\n    };\r\n\r\n    // Equip weapons\r\n\r\n    this.equipWeapon = function (weaponName, delay) {\r\n        var options = {action: window[weaponName + \"_EQUIP\"]};\r\n        options['callbackAnimationEnded'] = function (unit) {\r\n            unit._action = window[weaponName + \"_IDLE\"];\r\n        };\r\n\r\n        if (weaponName === WEAPON_SPEAR) {\r\n            var animationLength = 1300;\r\n        } else {\r\n            var animationLength = 1300;\r\n        }\r\n\r\n        this.queueAnimation(options, delay, animationLength);\r\n        return this;\r\n    };\r\n\r\n    // =========================================================================\r\n    // Positioning\r\n\r\n    this.positionRandomly = function () {\r\n        this.positionPX = rand(0, engineView.width);\r\n        this.positionPY = rand(0, engineView.height);\r\n        return this;\r\n    };\r\n\r\n    this.position = function (x, y) {\r\n        if (!x && !y) {\r\n            return {x: this.positionPX, y: this.positionPY};\r\n        } else {\r\n            this.positionPX = x;\r\n            this.positionPY = y;\r\n            return this;\r\n        }\r\n    };\r\n\r\n    // =========================================================================\r\n    // HTML creation\r\n\r\n    this.createImageElement = function () {\r\n        var id = \"unit-img-\" + this._id;\r\n        var idString = this._id ? \"id='\" + id + \"'\" : \"\";\r\n        var imgClass = \"\";\r\n\r\n        // Animated image\r\n        if (!this.isStaticImage()) {\r\n            var imgName = BASE_IMG_DIR + \"all/\" + this._sex + this._type + this._action + \"_\" + this._dir;\r\n//            var imgName = \"/image/critter/all/\" + this._sex + this._type + this._action + \"_\" + this._dir;\r\n//            var randomString = \"?\" + rand(100000, 999999);\r\n//            var randomString = \"?\" + this._id + \"-\" + rand(0, 99999);\r\n//            var randomString = \"?\" + this._id;\r\n//            var imagePath = imgName + \".gif\" + randomString;\r\n//            var imagePath = imgName + \".gif?\" + this._id;\r\n            var imagePath = imgName + \".gif\";\r\n            imgClass = \"unit-alive\";\r\n//            specialAttributes = \"loop=infinite\";\r\n        }\r\n\r\n        // Static image\r\n        else {\r\n            var natureGroupName = this._type.substring(7);\r\n            var imgName = \"/img/nature/\" + natureGroupName + \"/\" + rand(1, numOfImages[natureGroupName]);\r\n            var imagePath = imgName + \".png\";\r\n        }\r\n\r\n        // =========================================================================\r\n        // Direction issues\r\n//        if (!this.isActionStatic()) {\r\n//            if (this.dirTowardEast()) {\r\n//                this.marginLeft = 0;\r\n//            }\r\n//            else if (this.dirTowardWest()) {\r\n//                this.marginLeft = 0;\r\n//            }\r\n//        }\r\n//        this.marginTop = 60 + $(\"#\" + id).height() * -1;\r\n//        this.marginTop = 15;\r\n//        if (this.dirTowardNorth()) {\r\n        //        }\r\n\r\n        // =========================================================================\r\n        // Response contains various elements that can be needed, include them all\r\n\r\n//        var styleString = \"border: 1px solid red !important\";\r\n        var imageElement = \"<img \" + idString + \" class='\" + imgClass + \"' src='\" + imagePath + \"' />\";\r\n        return {\"imageElement\": imageElement, \"imagePath\": imagePath};\r\n    };\r\n\r\n    // =========================================================================\r\n    // Low-level methods\r\n\r\n    this.createImageWrapper = function () {\r\n        var unitIdString = \"unit-wrapper-\" + this._id;\r\n\r\n        if (this._divSelector !== null) {\r\n            this._divSelector.html(\"<div class='engine-unit' id='\" + unitIdString + \"'></div>\");\r\n        } else {\r\n            $(\"#canvas\").append(\"<div class='engine-unit' id='\" + unitIdString + \"'></div>\");\r\n            this._divSelector = $(\"#canvas #\" + unitIdString);\r\n        }\r\n    };\r\n\r\n    this.handleOptions = function (options) {\r\n        if (options) {\r\n            if (typeof options.action !== 'undefined') {\r\n                this._action = options.action;\r\n            }\r\n            if (typeof options.sex !== 'undefined') {\r\n                this._sex = options.sex;\r\n            }\r\n            if (typeof options.dir !== 'undefined') {\r\n                this._dir = options.dir;\r\n            }\r\n            if (typeof options.type !== 'undefined') {\r\n                this._type = options.type;\r\n            }\r\n        }\r\n        return this;\r\n    };\r\n\r\n    this.dirTowardEast = function () {\r\n        return [DIR_E, DIR_SE, DIR_NE].indexOf(this._dir) !== -1;\r\n    };\r\n\r\n    this.dirTowardWest = function () {\r\n        return [DIR_W, DIR_NW, DIR_SW].indexOf(this._dir) !== -1;\r\n    };\r\n\r\n    this.dirTowardNorth = function () {\r\n        return [DIR_NW, DIR_NE].indexOf(this._dir) !== -1;\r\n    };\r\n\r\n    this.dirTowardSouth = function () {\r\n        return [DIR_SW, DIR_SE].indexOf(this._dir) !== -1;\r\n    };\r\n\r\n//    this.isActionStatic = function () {\r\n//        return [ACTION_IDLE, SPEAR_IDLE].indexOf(this._dir) != -1;\r\n//        return false;\r\n    //    };\r\n\r\n    this.isStaticImage = function () {\r\n        return this._type !== null && stringStartsWith(this._type, \"nature_\");\r\n    };\r\n\r\n    this.isActionWalk = function () {\r\n        return this._action.charAt(1) === \"b\";\r\n    };\r\n\r\n    this.isActionWithWeapon = function (weaponName) {\r\n        if (weaponName === WEAPON_SPEAR) {\r\n            weaponLetter = \"g\";\r\n        } else {\r\n            weaponLetter = \"a\"; // Generic actions\r\n        }\r\n        return this._action.charAt(0) === weaponLetter.charAt(0);\r\n    };\r\n\r\n    // =========================================================================\r\n    // Getters and Setters\r\n\r\n    /**\r\n     * Getter or Setter for <b>dir</b> field.\r\n     * @param newDir one of DIR_* variables\r\n     */\r\n    this.dir = function (newDir) {\r\n        if (newDir !== undefined) {\r\n            this._dir = newDir;\r\n        } else {\r\n            return this._dir;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Getter or Setter for <b>action</b> field.\r\n     * @param newAction one of ACTION_* variables or others like that\r\n     */\r\n    this.action = function (newAction) {\r\n        if (newAction !== undefined) {\r\n            this._action = newAction;\r\n        } else {\r\n            return this._action;\r\n        }\r\n    };\r\n\r\n}\r\n\r\n// =========================================================================\r\n\r\n__firstFreeUnitId = 100;\r\n","function isDefined(param) {\r\n    return typeof param != 'undefined';\r\n}\r\n\r\nfunction isUndefined(param) {\r\n    return typeof param == 'undefined';\r\n}\r\n\r\nfunction cloneObject(object) {\r\n    return JSON.parse(JSON.stringify(object));\r\n}","function getMapCoordinatesFromScreenClick(event) {\r\n\r\n    // Define click on map canvas manually, because if clicked on a child, it changes .offsetX value.\r\n    var canvasX = event.pageX - WORLDMAP_CANVAS_MARGIN_LEFT;\r\n    var canvasY = event.pageY - WORLDMAP_CANVAS_MARGIN_TOP;\r\n\r\n    return getMapCoordinatesFromCanvasCoordinates(canvasX, canvasY);\r\n}\r\n\r\nfunction getMapCoordinatesFromCanvasCoordinates(canvasX, canvasY) {\r\n\r\n    // X-related\r\n    var coordinatesOffsetX = getMapOffsetPixelsX() * getWorldmapZoom();\r\n    var mapScreenWidth = WORLDMAP_CANVAS_WIDTH * getWorldmapZoom();\r\n    var mapScreenWidthPercent = canvasX / WORLDMAP_CANVAS_WIDTH;\r\n\r\n    // Y-related\r\n    var coordinatesOffsetY = getMapOffsetPixelsY() * getWorldmapZoom();\r\n    var mapScreenHeight = WORLDMAP_CANVAS_HEIGHT * getWorldmapZoom();\r\n    var mapScreenHeightPercent = canvasY / WORLDMAP_CANVAS_HEIGHT;\r\n\r\n    // Return object\r\n    var mapX = parseInt(coordinatesOffsetX + mapScreenWidthPercent * mapScreenWidth);\r\n    var mapY = parseInt(coordinatesOffsetY + mapScreenHeightPercent * mapScreenHeight);\r\n    return {'mapX': mapX, 'mapY': mapY};\r\n}\r\n\r\nfunction getCanvasCoordinatesFromMapCoordinates(mapX, mapY) {\r\n    return {\r\n        'canvasX': WORLDMAP_CANVAS_MARGIN_LEFT + mapX / getWorldmapZoom() - getMapOffsetPixelsX() + 2,\r\n        'canvasY': WORLDMAP_CANVAS_MARGIN_TOP + mapY / getWorldmapZoom() - getMapOffsetPixelsY() + 1\r\n    };\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction getCurrentTopLeftPointMapCoordinates() {\r\n    return getMapCoordinatesFromCanvasCoordinates(0, 0);\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction coordinatesToString(coordinates) {\r\n    if ('canvasX' in coordinates) {\r\n        return \"[\" + coordinates['canvasX'] + \",\" + coordinates['canvasY'] + \"]\";\r\n    } else {\r\n        return \"[\" + coordinates['mapX'] + \",\" + coordinates['mapY'] + \"]\";\r\n    }\r\n}","function HtmlElement(left, top) {\n\n    this._id = null; // Unique identifier\n    this._selector = null; // jQuery selector of this html element\n    this._top = null; // CSS \"top\" value in pixels\n    this._left = null; // CSS \"left\" value in pixels\n    this._htmlDOM = null; // DOM element that was used to create this html element\n    this._styleString = null; // All styles for this element except \"top\" and \"left\"\n    this._htmlString = null; // Ready html string\n\n    // =========================================================================\n    // Constructor\n\n    this.constructor = function (left, top) {\n        this._id = __firstFreeWorldmapElementId++;\n        this._htmlDOM = document.createElement(\"div\");\n        this._left = left;\n        this._top = top;\n\n//        for (var fieldName in options) {\n//            var value = options[fieldName];\n//            fieldName = \"_\" + fieldName;\n//            this.fieldName = value;\n//        }\n    };\n    this.constructor(left, top);\n\n    // =========================================================================\n\n    this.getId = function () {\n        return this._id;\n    };\n\n    this.getSelector = function () {\n        if (this._selector === null) {\n            this._selector = $(\"#html-element-\" + this._id)\n        }\n        return this._selector;\n    };\n\n    // === Style ======================================================================\n\n    this.setStyle = function (styleString) {\n        this._styleString = styleString;\n        this._htmlDOM.setAttribute('id', 'html-element-' + this._id);\n        this._htmlDOM.setAttribute('style', styleString);\n    };\n\n    // === HTML elements ======================================================================\n\n    this.getHtml = function () {\n        if (this._htmlString === null) {\n            this.prepareHtml();\n        }\n        return this._htmlString;\n    };\n\n    this.prepareHtml = function () {\n        this.updateHtmlDOMPosition();\n        this._htmlString = this._htmlDOM.outerHTML;\n    };\n\n    this.updateHtmlDOMPosition = function () {\n        var style = this._styleString;\n        style += \"top:\" + this._top + \"px;\";\n        style += \"left:\" + this._left + \"px;\";\n        this._htmlDOM.setAttribute('style', style);\n    };\n\n    // === Position ======================================================================\n\n    this.translate = function (dx, dy) {\n        this._left += dx;\n        this._top += dy;\n\n        this.getSelector().css({\n            'left': this._left + 'px',\n            'top': this._top + 'px'\n        });\n    };\n\n//    this.setTop = function (top) {\n//        this._top = top;\n//    };\n\n//    this.getTop = function () {\n//        return this._top;\n//    };\n\n//    this.setLeft = function (left) {\n//        this._left = left;\n//    };\n\n//    this.getLeft = function () {\n//        return this._left;\n//    };\n\n}\n\n// =========================================================================\n\n__firstFreeWorldmapElementId = 1;\n\n","var FORBID_RIGHT_CLICK = false;\r\n\r\n// =========================================================================\r\n\r\nvar mouseIsClicked = false;\r\nvar mousePreviousPosition = null;\r\nvar mouseHasMoved = false;\r\n\r\n// === Map events ======================================================================\r\n\r\nfunction initializeWorldmapEvents() {\r\n    $(\".worldmap-location\")\r\n            .mousedown(function (event) {\r\n                mapMouseDown(event);\r\n                event.stopPropagation();\r\n            })\r\n            .mouseup(function (event) {\r\n                mapMouseUp(event);\r\n                event.stopPropagation();\r\n            })\r\n            .mousemove(function (event) {\r\n                mapMouseMove(event);\r\n                event.stopPropagation();\r\n            });\r\n\r\n    $(\".worldmap\")\r\n            .mousedown(function (event) {\r\n                mapMouseDown(event);\r\n            })\r\n            .mouseup(function (event) {\r\n                mapMouseUp(event);\r\n            })\r\n            .mousemove(function (event) {\r\n                mapMouseMove(event);\r\n            })\r\n            .mousewheel(function (event) {\r\n                mapScroll(event);\r\n            })\r\n            .mouseleave(function (event) {\r\n                mapMouseLeave(event);\r\n            })\r\n            .contextmenu(function (event) {\r\n                if (FORBID_RIGHT_CLICK) {\r\n                    event.preventDefault(); // Stop the context menu\r\n                }\r\n            });\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction mapMouseDown(event) {\r\n    worldmap = $(\".worldmap\");\r\n\r\n    // Right click\r\n    if (event.button === 2) {\r\n//        console.log(\"Right click\");\r\n//        event.preventDefault();\r\n//        event.stopPropagation()();\r\n//        return true;\r\n    }\r\n\r\n    // Left or middle click\r\n    else {\r\n//        worldmapMessage(\"Maximum zoom reached!\", \"#f35\");\r\n    }\r\n\r\n    mousePreviousPosition = event;\r\n    mouseIsClicked = true;\r\n    mouseHasMoved = false;\r\n}\r\n\r\nfunction mapMouseUp(event) {\r\n    if (!mouseHasMoved) {\r\n        mapClick(event);\r\n    }\r\n\r\n    mouseIsClicked = false;\r\n    mousePreviousPosition = null;\r\n    mouseHasMoved = false;\r\n}\r\n\r\nfunction mapMouseMove(event) {\r\n    if (mouseIsClicked) {\r\n        mouseHasMoved = true;\r\n    }\r\n\r\n    if (mouseIsClicked && mousePreviousPosition != null) {\r\n        translationVector = moveWorldmapBackgroundImage(event);\r\n        moveWorldmapObjects(translationVector);\r\n    }\r\n\r\n    mousePreviousPosition = event;\r\n\r\n    // =========================================================================\r\n    // Show coords\r\n    worldmapMessageForever(\r\n            \"Mouse points to \" + coordinatesToString(getMapCoordinatesFromScreenClick(event)), 'mouse-cords'\r\n            );\r\n}\r\n\r\nfunction mapScroll(event) {\r\n    var scrollType = event.deltaY; // 1 for wheel up, -1 for wheel down\r\n\r\n    // Wheel up\r\n    if (scrollType >= 1) {\r\n        changeZoom(event, false);\r\n    }\r\n\r\n    // Wheel down\r\n    else if (scrollType <= -1) {\r\n        changeZoom(event, true);\r\n    }\r\n\r\n    // Force mouse move event as scroll will change cursor relative position on the map\r\n    mapMouseMove(event);\r\n}\r\n\r\nfunction mapMouseLeave(event) {\r\n    if (mouseIsClicked) {\r\n        mapMouseUp(event);\r\n        mouseIsClicked = false;\r\n    }\r\n}\r\n\r\nfunction mapClick(event) {\r\n    var coordinates = getMapCoordinatesFromScreenClick(event);\r\n    gameLog('<span>[' + coordinates['mapX'] + ',' + coordinates['mapY'] + ']</span> is unknown wasteland, '\r\n            + 'not very hospitable place.');\r\n}","var WORLDMAP_LOCATION_SIZE = null;\r\nvar WORLDMAP_LOCATION_LABEL_MARGIN_LEFT = null;\r\nvar WORLDMAP_LOCATION_LABEL_MARGIN_TOP = null;\r\n\r\nvar _WORLDMAP_LOCATION_SIZE_MODIFIER = 35;\r\nvar _WORLDMAP_LOCATION_LABEL_WIDTH = 100;\r\n\r\n// =========================================================================\r\n\r\nfunction initializeWorldmapLocations() {\r\n    recalculateWorldmapLocationVariables();\r\n\r\n    worldmapLocations.forEach(function (location, index) {\r\n        getWorldmap().append(createHtmlFromLocationJson(location, index));\r\n    });\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction createHtmlFromLocationJson(location, index) {\r\n    var id = location['_id'];\r\n//    var text = location['location']['x'] + \",\" + location['location']['y'];\r\n    var text = location['name'];\r\n    var labelWidth = WORLDMAP_LOCATION_SIZE;\r\n\r\n    var canvasCoordinates = getCanvasCoordinatesFromMapCoordinates(\r\n//            location['location']['x'] - size / 2, location['location']['y'] - size / 2\r\n            location['location']['x'], location['location']['y']\r\n            );\r\n\r\n    var locationStyle = 'top:' + (canvasCoordinates['canvasY'] - WORLDMAP_LOCATION_SIZE / 2) + 'px;left:'\r\n            + (canvasCoordinates['canvasX'] - WORLDMAP_LOCATION_SIZE / 2) + 'px;'\r\n            + 'width:' + WORLDMAP_LOCATION_SIZE + 'px;height:' + WORLDMAP_LOCATION_SIZE + 'px';\r\n\r\n    var labelStyle = 'margin-top:' + WORLDMAP_LOCATION_LABEL_MARGIN_TOP\r\n            + 'px;margin-left:' + WORLDMAP_LOCATION_LABEL_MARGIN_LEFT + 'px';\r\n\r\n    return '<div class=\"worldmap-location\" id=\"worldmap-location-' + id + '\" '\r\n            + 'variableName=\"worldmapLocations\" variableIndex=\"' + index + '\" style=\"' + locationStyle + '\">'\r\n            + '<label style=\"' + labelStyle + '\">' + text + '</label>'\r\n            + '</div>';\r\n}\r\n\r\nfunction recalculateWorldmapLocationVariables() {\r\n    WORLDMAP_LOCATION_SIZE = _WORLDMAP_LOCATION_SIZE_MODIFIER / getWorldmapZoom();\r\n    WORLDMAP_LOCATION_BORDER_WIDTH = 1.5;\r\n    WORLDMAP_LOCATION_LABEL_MARGIN_TOP = _WORLDMAP_LOCATION_SIZE_MODIFIER / getWorldmapZoom() * 1.02;\r\n    WORLDMAP_LOCATION_LABEL_MARGIN_LEFT = -_WORLDMAP_LOCATION_LABEL_WIDTH / 2 + WORLDMAP_LOCATION_SIZE / 2\r\n            - WORLDMAP_LOCATION_BORDER_WIDTH + 1;\r\n}","var _WORLDMAP_MESSAGE_SHOW_TIME = 2000;\r\nvar _WORLDMAP_MESSAGE_DIM_INTERVAL = 100;\r\n\r\nvar _worldmapMessageFirstFreeId = 10000;\r\n\r\n// =========================================================================\r\n\r\nfunction gameLog(message) {\r\n    $(\".game-log p\").css('opacity', '0.7');\r\n\r\n    $(\".game-log\").prepend(\"<p style='display: none' class='game-log-invisible'><span class='dot'></span> \"\r\n            + message + \"</p>\");\r\n\r\n    $(\".game-log .game-log-invisible\").slideDown(700);\r\n}\r\n\r\nfunction worldmapMessageForever(text, uniqueForeverMessageId, color) {\r\n    if (typeof uniqueForeverMessageId == 'undefined') {\r\n        console.error(\"Did not pass worldmapMessageForever unique id!\");\r\n        return;\r\n    }\r\n    return worldmapMessage(text, color, uniqueForeverMessageId);\r\n}\r\n\r\nfunction worldmapMessage(text, color, uniqueForeverMessageId) {\r\n    if (color) {\r\n        color = \"color: \" + color;\r\n    }\r\n\r\n    // Define message id\r\n    var messageId = 'game-message-' + (isDefined(uniqueForeverMessageId) ?\r\n            uniqueForeverMessageId : _worldmapMessageFirstFreeId++);\r\n\r\n    // =========================================================================\r\n    // Remove previous message if needed\r\n\r\n    if (uniqueForeverMessageId) {\r\n        var message = $(\"#\" + messageId);\r\n        if (message.length > 0) {\r\n            message.text(text);\r\n            return;\r\n        }\r\n    }\r\n\r\n    // =========================================================================\r\n    // Add html element of message\r\n    $(\".game-messages\").append(\"<div class='game-message' id='\" + messageId + \"' style='width: \"\r\n            + WORLDMAP_CANVAS_WIDTH + \"px;\" + color + \";opacity:1.0'>\" + text + \"</div>\");\r\n\r\n    // =========================================================================\r\n    // Decrease message's opacity with time\r\n    if (!uniqueForeverMessageId) {\r\n        setTimeout(function () {\r\n            _dimMessageWithTime(messageId);\r\n        }, _WORLDMAP_MESSAGE_SHOW_TIME);\r\n    }\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction _dimMessageWithTime(messageId) {\r\n    var message = $(\"#\" + messageId);\r\n    var opacity = message.css('opacity');\r\n    if (opacity <= 0) {\r\n        var hideTime = 400;\r\n        message.hide(hideTime);\r\n        setTimeout(function () {\r\n            message.remove();\r\n        }, hideTime);\r\n    } else {\r\n        message.css('opacity', message.css('opacity') - 0.03);\r\n        setTimeout(function () {\r\n            _dimMessageWithTime(messageId);\r\n        }, _WORLDMAP_MESSAGE_DIM_INTERVAL + opacity * 100);\r\n    }\r\n}","var MOUSE_DRAG_MODIFIER = 1;\r\n\r\n// === Move map / objects ==============================================================\r\n\r\nfunction moveWorldmapBackgroundImage(eventOrX, yOrNull) {\r\n    if (isUndefined(yOrNull)) {\r\n        var dx = eventOrX.pageX - mousePreviousPosition.pageX;\r\n        var dy = eventOrX.pageY - mousePreviousPosition.pageY;\r\n    } else {\r\n        var dx = eventOrX;\r\n        var dy = yOrNull;\r\n    }\r\n\r\n    // =========================================================================\r\n    // Get current image position\r\n    var imagePosX = -1 * getMapOffsetPixelsX();\r\n    var imagePosY = -1 * getMapOffsetPixelsY();\r\n\r\n    // Modify variable image position\r\n    deltaImagePosX = dx;\r\n    deltaImagePosY = dy;\r\n    imagePosX += deltaImagePosX;\r\n    imagePosY += deltaImagePosY;\r\n    imagePosXWithScreenWidth = imagePosX - WORLDMAP_CANVAS_WIDTH;\r\n    imagePosYWithScreenHeight = imagePosY - WORLDMAP_CANVAS_HEIGHT;\r\n\r\n    // Force image to be horizontally in bounds\r\n    if (imagePosX > 0) {\r\n        var oldImagePosX = imagePosX;\r\n        imagePosX = 0;\r\n        deltaImagePosX -= (oldImagePosX - imagePosX);\r\n    } else if (imagePosXWithScreenWidth <= -WORLDMAP_WIDTH / getWorldmapZoom()) {\r\n        var oldImagePosX = imagePosX;\r\n        imagePosX = -WORLDMAP_WIDTH / getWorldmapZoom() + WORLDMAP_CANVAS_WIDTH;\r\n        deltaImagePosX -= (oldImagePosX - imagePosX);\r\n    }\r\n\r\n    // Force image to be vertically in bounds\r\n    if (imagePosY > 0) {\r\n        var oldImagePosY = imagePosY;\r\n        imagePosY = 0;\r\n        deltaImagePosY -= (oldImagePosY - imagePosY);\r\n    } else if (imagePosYWithScreenHeight <= -WORLDMAP_HEIGHT / getWorldmapZoom()) {\r\n        var oldImagePosY = imagePosY;\r\n        imagePosY = -WORLDMAP_HEIGHT / getWorldmapZoom() + WORLDMAP_CANVAS_HEIGHT;\r\n        deltaImagePosY -= (oldImagePosY - imagePosY);\r\n    }\r\n\r\n    // Remember current view position\r\n    updateViewRectangle(-1 * imagePosX, -1 * imagePosY);\r\n\r\n    // =========================================================================\r\n\r\n    return {dx: deltaImagePosX, dy: deltaImagePosY};\r\n}\r\n\r\nfunction moveWorldmapObjects(translationVector) {\r\n    var allWorldmapObjects = getAllWorldmapObjects();\r\n//    console.log(\"==== WORLDMAP OBJECTS =====\");\r\n    for (var key in allWorldmapObjects) {\r\n        var worldmapObject = allWorldmapObjects[key];\r\n//        console.log(worldmapObject);\r\n    }\r\n\r\n    // =========================================================================\r\n    // Locations\r\n\r\n    var mapLocations = $(\".worldmap-location\");\r\n    $.each(mapLocations, function (index, object) {\r\n        var mapObject = $(\"#\" + object['id']);\r\n        mapObject.css({\r\n            'top': parseFloat(mapObject.css('top')) + translationVector['dy'],\r\n            'left': parseFloat(mapObject.css('left')) + translationVector['dx']\r\n        });\r\n    });\r\n\r\n    // =========================================================================\r\n    // Worldmap objects\r\n\r\n    $.each(_allWorldmapObjects, function (index, worldmapObject) {\r\n        worldmapObject.translate(translationVector['dx'], translationVector['dy']);\r\n    });\r\n}","function WorldmapObject(options) {\n\n    this._id = null; // Unique identifier for the worldmap object\n    this._x = null; //\n    this._y = null; //\n    this._x2 = null; //\n    this._y2 = null; //\n    this._htmlElements = []; //\n\n    // =========================================================================\n    // Constructor\n\n    this.constructor = function (options) {\n        this._id = __firstFreeWorldmapObjectId++;\n\n        for (var fieldName in options) {\n            var value = options[fieldName];\n            fieldName = \"_\" + fieldName;\n            this.fieldName = value;\n        }\n    };\n    this.constructor(options);\n\n    this.getId = function () {\n        return this._id;\n    };\n\n    // === HTML elements ======================================================================\n\n    this.addHtmlElement = function (htmlElement) {\n        var htmlElementId = htmlElement.getId();\n        this._htmlElements[htmlElementId] = htmlElement;\n        return this;\n    };\n\n    this.getHtmlElements = function () {\n        return this._htmlElements.slice();\n    };\n\n    // === Coordinates ======================================================================\n\n    this.setCoordinates = function (x, y) {\n        this._x = x;\n        this._y = y;\n        return this;\n    };\n\n    this.setEndCoordinates = function (x2, y2) {\n        this._x2 = x2;\n        this._y2 = y2;\n        return this;\n    };\n\n    this.getCoordinates = function () {\n        return {'x': this._x, 'y': this._y};\n    };\n\n    this.translate = function (dx, dy) {\n        this._x += dx;\n        this._y += dy;\n\n        for (var htmlElementId in this._htmlElements) {\n            var htmlElementObject = this._htmlElements[htmlElementId];\n            htmlElementObject.translate(dx, dy);\n        }\n    };\n\n}\n\n// =========================================================================\n\n__firstFreeWorldmapObjectId = 1;","var _allWorldmapObjects = {};\r\n\r\n// =========================================================================\r\n\r\nfunction getAllWorldmapObjects() {\r\n    return _allWorldmapObjects;\r\n}\r\n\r\nfunction addWorldmapObject(worldmapObject) {\r\n\r\n    // For every html element, add it to the worldmap canvas\r\n    var htmlElements = worldmapObject.getHtmlElements();\r\n    for (var index in htmlElements) {\r\n        var htmlElement = htmlElements[index];\r\n        getWorldmap().append(htmlElement.getHtml());\r\n    }\r\n\r\n    // Add object to the list\r\n    _allWorldmapObjects[worldmapObject.getId()] = worldmapObject;\r\n}\r\n\r\n","WENGINE_DEFAULT_LINE_WIDTH = 1;\r\n\r\n// =========================================================================\r\n\r\nwindow.initQueue.push(function () {\r\n    setTimeout(function () {\r\n        var rect = getWorldmapViewRectangle();\r\n        var TEMP = 30;\r\n\r\n        rect['x'] += TEMP;\r\n        rect['y'] += TEMP;\r\n        rect['width'] -= 2 * TEMP + WENGINE_DEFAULT_LINE_WIDTH;\r\n        rect['height'] -= 2 * TEMP + WENGINE_DEFAULT_LINE_WIDTH;\r\n        rect['width'] /= getWorldmapZoom();\r\n        rect['height'] /= getWorldmapZoom();\r\n\r\n//        WEngine_paintRectangleFromArray(rect, {'background-color': 'transparent'});\r\n        paintTest();\r\n    }, 160);\r\n});\r\n\r\n// =========================================================================\r\n\r\nvar testLineX1;\r\nvar testLineY1;\r\nvar testLineX2;\r\nvar testLineY2;\r\nfunction paintTest() {\r\n    testLineX1 = _WORLDMAP_IMAGE_INITIAL_X + 300;\r\n    testLineY1 = _WORLDMAP_IMAGE_INITIAL_Y + 400;\r\n    testLineX2 = testLineX1;\r\n    testLineY2 = testLineY1;\r\n\r\n    var line = WEngine_paintLine(testLineX1, testLineY1, testLineX2, testLineY2);\r\n    console.log(line);\r\n\r\n    setTimeout(function () {\r\n        testLineX2\r\n    }, 100);\r\n}\r\n\r\n// === Public ======================================================================\r\n\r\nfunction WEngine_paintLine(x1, y1, x2, y2, options, worldmapObject) {\r\n    //    console.log(\"Line: \" + x1 + \",\" + y1 + \" / \" + x2 + \",\" + y2);\r\n    canvasCoords = getCanvasCoordinatesFromMapCoordinates(x1, y1);\r\n    x1 = canvasCoords['canvasX'];\r\n    y1 = canvasCoords['canvasY'];\r\n    canvasCoords = getCanvasCoordinatesFromMapCoordinates(x2, y2);\r\n    x2 = canvasCoords['canvasX'];\r\n    y2 = canvasCoords['canvasY'];\r\n\r\n    var line = _WEngine_getLine(x1, y1, x2, y2, options);\r\n\r\n    // =========================================================================\r\n    // Worldmap object related - automatically create only if no worldmapObject was passed\r\n    if (isUndefined(worldmapObject)) {\r\n        worldmapObject = new WorldmapObject();\r\n        worldmapObject.setCoordinates(x1, y1);\r\n        worldmapObject.setEndCoordinates(x2, y2);\r\n        worldmapObject.addHtmlElement(line);\r\n        addWorldmapObject(worldmapObject);\r\n\r\n        // Return WORLDMAP OBJECT\r\n        return worldmapObject;\r\n    }\r\n\r\n    // If passed existing WorldmapObject return HTML ELEMENT\r\n    else {\r\n        return line;\r\n    }\r\n}\r\n\r\nfunction WEngine_paintRectangleFromArray(array, options) {\r\n    return WEngine_paintRectangle(\r\n            array['x'], array['y'], array['x'] + array['width'], array['y'] + array['height'], options\r\n            );\r\n}\r\n\r\nfunction WEngine_paintRectangle(x1, y1, x2, y2, options) {\r\n    var worldmapObject = new WorldmapObject();\r\n    worldmapObject.setCoordinates(x1, y1);\r\n    worldmapObject.setEndCoordinates(x2, y2);\r\n\r\n    worldmapObject.addHtmlElement(WEngine_paintLine(x1, y1, x2, y1, options, worldmapObject)); // Horiz Top\r\n    worldmapObject.addHtmlElement(WEngine_paintLine(x1, y2, x2, y2, options, worldmapObject)); // Horiz Bottom\r\n    worldmapObject.addHtmlElement(WEngine_paintLine(x1, y1, x1, y2, options, worldmapObject)); // Vert Left\r\n    worldmapObject.addHtmlElement(WEngine_paintLine(x2, y1, x2, y2, options, worldmapObject)); // Vert Right\r\n\r\n    addWorldmapObject(worldmapObject);\r\n    return worldmapObject;\r\n}\r\n\r\n// === Private ======================================================================\r\n\r\nfunction _WEngine_getLine(x1, y1, x2, y2, options) {\r\n    var a = x1 - x2,\r\n            b = y1 - y2,\r\n            c = Math.sqrt(a * a + b * b);\r\n\r\n    var sx = (x1 + x2) / 2,\r\n            sy = (y1 + y2) / 2;\r\n\r\n    var x = sx - c / 2,\r\n            y = sy;\r\n\r\n    var alpha = Math.PI - Math.atan2(-b, a);\r\n\r\n    return _WEngine_getLine_element(x, y, c, alpha, options);\r\n}\r\n\r\n// === Html elements ======================================================================\r\n\r\n//function _WEngine_getLine_element(x, y, length, angle, options) {\r\n//    var line = document.createElement(\"div\");\r\n//    var styles = 'border: ' + WENGINE_DEFAULT_LINE_WIDTH + 'px dashed red; '\r\n//            + 'width: ' + length + 'px; '\r\n//            + 'height: 0px; '\r\n//            + '-moz-transform: rotate(' + angle + 'rad); '\r\n//            + '-webkit-transform: rotate(' + angle + 'rad); '\r\n//            + '-o-transform: rotate(' + angle + 'rad); '\r\n//            + '-ms-transform: rotate(' + angle + 'rad); '\r\n//            + 'position: absolute; '\r\n//            + 'top: ' + y + 'px; '\r\n//            + 'left: ' + x + 'px; ';\r\n//\r\n//    if (isDefined(options)) {\r\n//        for (var option in options) {\r\n//            styles += option + ':' + options[option] + ';';\r\n//        }\r\n//    }\r\n//\r\n//    line.setAttribute('style', styles);\r\n//    _WEngine_assignIdToHtmlElement(line);\r\n//    return line;\r\n//}\r\nfunction _WEngine_getLine_element(x, y, length, angle, options) {\r\n    var lineHtmlElement = new HtmlElement(x, y);\r\n    var style = 'border: ' + WENGINE_DEFAULT_LINE_WIDTH + 'px dashed red; '\r\n            + 'width: ' + length + 'px; '\r\n            + 'height: 0px; '\r\n            + '-moz-transform: rotate(' + angle + 'rad); '\r\n            + '-webkit-transform: rotate(' + angle + 'rad); '\r\n            + '-o-transform: rotate(' + angle + 'rad); '\r\n            + '-ms-transform: rotate(' + angle + 'rad); '\r\n            + 'position: absolute; ';\r\n//            + 'top: ' + y + 'px; '\r\n//            + 'left: ' + x + 'px; ';;\r\n\r\n    if (isDefined(options)) {\r\n        for (var option in options) {\r\n            style += option + ':' + options[option] + ';';\r\n        }\r\n    }\r\n\r\n    lineHtmlElement.setStyle(style);\r\n    return lineHtmlElement;\r\n}\r\n\r\n// =========================================================================\r\n\r\n//function _WEngine_assignIdToHtmlElement(element) {\r\n//    __lastHtmlElementId = (__firstFreeWorldmapObjectHtmlElementId++);\r\n//    element.setAttribute('id', 'html-element-' + __lastHtmlElementId);\r\n//    return __lastHtmlElementId;\r\n//}\r\n\r\n__firstFreeWorldmapObjectHtmlElementId = 100;\r\n//__lastHtmlElementId = null;","\r\n// Initial view settings\r\nvar _WORLDMAP_IMAGE_INITIAL_WIDTH = 3500;\r\nvar _WORLDMAP_IMAGE_INITIAL_X = 1000;\r\nvar _WORLDMAP_IMAGE_INITIAL_Y = 1000;\r\n\r\n// View rectangle\r\nvar _worldmapViewRectangle = null;\r\nvar _currentWorldmapImageWidth = null;\r\nvar _currentWorldmapImageHeight = null;\r\n\r\n// === Set up view & zoom ===================================================\r\n\r\nfunction initializeWorldmapView() {\r\n\r\n    // Define rectangle view width and height\r\n    _currentWorldmapImageWidth = _WORLDMAP_IMAGE_INITIAL_WIDTH;\r\n    _currentWorldmapImageHeight = _currentWorldmapImageWidth * WORLDMAP_CANVAS_WIDTH / WORLDMAP_CANVAS_HEIGHT;\r\n\r\n    // Definte rectangle view\r\n    _worldmapViewRectangle = {\r\n        'x': _WORLDMAP_IMAGE_INITIAL_X,\r\n        'y': _WORLDMAP_IMAGE_INITIAL_Y,\r\n        'width': WORLDMAP_CANVAS_WIDTH,\r\n        'height': WORLDMAP_CANVAS_HEIGHT\r\n    };\r\n\r\n    // Init zoom\r\n    initializeWorldmapZoom();\r\n\r\n    // Assign proper values for background image\r\n    updateViewRectangle(_worldmapViewRectangle['x'], _worldmapViewRectangle['y']);\r\n}\r\n\r\n// === Public ======================================================================\r\n\r\nfunction getWorldmapViewRectangle() {\r\n    return cloneObject(_worldmapViewRectangle);\r\n}\r\n\r\nfunction getWorldmapViewRectangleWidth() {\r\n    return _worldmapViewRectangle['width'];\r\n}\r\n\r\nfunction getWorldmapViewRectangleHeight() {\r\n    return _worldmapViewRectangle['height'];\r\n}\r\n\r\nfunction getMapOffsetPixelsX() {\r\n    return _worldmapViewRectangle['x'];\r\n}\r\n\r\nfunction getMapOffsetPixelsY() {\r\n    return _worldmapViewRectangle['y'];\r\n}\r\n\r\nfunction updateViewRectangle(xOrObject, yOrObject) {\r\n\r\n    // If params are defined, it means we need to move by view rectangle [x,y]\r\n    if (isDefined(xOrObject)) {\r\n        var newX, newY;\r\n        if (xOrObject != null) {\r\n            newX = Math.abs(xOrObject);\r\n            newY = Math.abs(yOrObject);\r\n        } else {\r\n            newX = Math.abs(xOrObject['x']);\r\n            newY = Math.abs(yOrObject['y']);\r\n        }\r\n\r\n        _worldmapViewRectangle['x'] = newX;\r\n        _worldmapViewRectangle['y'] = newY;\r\n\r\n        // Update background image position\r\n        getWorldmap().css({\r\n            'background-position': -newX + \"px \" + -newY + \"px\"\r\n        });\r\n    }\r\n\r\n    // Update width and height of view rectangle\r\n    _worldmapViewRectangle['width'] = WORLDMAP_CANVAS_WIDTH / getWorldmapZoom();\r\n    _worldmapViewRectangle['height'] = WORLDMAP_CANVAS_HEIGHT / getWorldmapZoom();\r\n\r\n    // Update background image size\r\n    getWorldmap().css({\r\n        'background-size': _currentWorldmapImageWidth + \"px auto\"\r\n    });\r\n\r\n    // =========================================================================\r\n    // Return difference in view rectangle field values\r\n\r\n//    console.log('');\r\n//    console.log(\"NEW:\");\r\n//    console.log(_worldmapViewRectangle);\r\n//    console.log(\"OLD\");\r\n//    console.log(_oldWorldmapViewRectangle);\r\n\r\n//    return {\r\n//        'dX': (_worldmapViewRectangle['x'] - _oldWorldmapViewRectangle['x']),\r\n//        'dY': (_worldmapViewRectangle['y'] - _oldWorldmapViewRectangle['y']),\r\n//        'dWidth': (_worldmapViewRectangle['width'] - _oldWorldmapViewRectangle['width']),\r\n//        'dHeight': (_worldmapViewRectangle['height'] - _oldWorldmapViewRectangle['height'])\r\n//    };\r\n}","\n// Zoom animation\nvar _WORLDMAP_ZOOM_INTERVAL = 15; // Miliseconds of interval between zoom animations\nvar _WORLDMAP_ZOOM_ANIMATIONS = 25; // Number of zoom animations\n//var _WORLDMAP_ZOOM_SPEED_FACTOR = 3; //\nvar _worldmapZoomsToProceedCounter = 0; // How many zoom animation are left to proceed\n//var _worldmapZoomCurrentSpeed = 0; //\n\n// Zoom\nvar _MIN_ZOOM_VALUE = 0.58; // Do not lower - below this value some weird floating things happen\nvar _zoomStep = 50; // Background image width quantum pixel difference\nvar _zoom; // Current zoom - actually lower value is bigger zoom\nvar _zoomMessageWasShown = false;\n\n// Revert zoom\nvar _oldMapImageWidth = null;\nvar _oldZoom = null;\nvar _oldWorldmapViewRectangle = {'x': 0, 'y': 0, 'width': 0, 'height': 0};\n\n// =========================================================================\n\nfunction initializeWorldmapZoom() {\n    _recalculateZoom();\n}\n\n// === Public ======================================================================\n\nfunction getWorldmapZoom() {\n    return _zoom;\n}\n\nfunction changeZoom(event, isZoomIn) {\n    _zoomMessageWasShown = false;\n\n    _worldmapZoomsToProceedCounter = _WORLDMAP_ZOOM_ANIMATIONS;\n    _delayChangeZoom(event, isZoomIn);\n}\n\n// === Zoom related ==============================================================\n\nfunction _delayChangeZoom(event, isZoomIn) {\n    setTimeout(function () {\n        _processZoom(event, isZoomIn);\n    }, _WORLDMAP_ZOOM_INTERVAL);\n}\n\nfunction _processZoom(event, isZoomIn) {\n\n    // Validate that we need to zoom smoothly\n    if (_worldmapZoomsToProceedCounter > 0) {\n        _worldmapZoomsToProceedCounter--;\n//        _worldmapZoomCurrentSpeed += Math.sqrt(_WORLDMAP_ZOOM_SPEED_FACTOR);\n    } else {\n//        _worldmapZoomCurrentSpeed = 0;\n        return;\n    }\n\n    // =========================================================================\n    // Remember initial view variables\n    _oldMapImageWidth = _currentWorldmapImageWidth;\n    _oldZoom = _zoom;\n    _oldWorldmapViewRectangle = getWorldmapViewRectangle();\n\n    // =========================================================================\n    // Revert if zoom is not allowed (too far, too close)\n    if (!_changeZoomAndCheckIfAllowed(event, isZoomIn)) {\n        return _revertZoom(); // Returns nothing, just exits\n    }\n\n    // Zoom is okay\n    else {\n        updateViewRectangle();\n//        var diffInView = updateViewRectangle();\n//        console.log(diffInView);\n    }\n\n    // =========================================================================\n    // =========================================================================\n    // Update view rectangle, make sure in bound, apply small fixes to center etc\n    _afterZoomMakeSureWeReInbound(event, isZoomIn);\n\n    // =========================================================================\n    // Move every map location and change its size.\n    _afterZoomUpdateMapLocations();\n\n    // =========================================================================\n    // Fire mouse move event because the map has moved\n    mapMouseMove(event);\n\n    // =========================================================================\n    // Smoothly delay next zoom animation if needed\n    _delayChangeZoom(event, isZoomIn);\n}\n\nfunction _afterZoomMakeSureWeReInbound(event, isZoomIn) {\n    var topLeftCoords = getCurrentTopLeftPointMapCoordinates();\n    var dX = topLeftCoords['mapX'] - _oldWorldmapViewRectangle['x'];\n    var dY = topLeftCoords['mapY'] - _oldWorldmapViewRectangle['y'];\n\n    // Enforce that the view rectangle is in bounds; moving the worldmap by [0,0] does that\n    var counterModifier = 2;\n    if (isZoomIn) {\n        moveWorldmapBackgroundImage(_zoomStep / counterModifier, _zoomStep / counterModifier);\n    } else {\n        moveWorldmapBackgroundImage(_zoomStep / -counterModifier, _zoomStep / -counterModifier);\n    }\n}\n\nfunction _afterZoomUpdateMapLocations() {\n\n    // Recalculate margin-top for location label\n    recalculateWorldmapLocationVariables();\n\n    // Change location and size of every worldmap location\n    var worldmapLocations = $(\".worldmap-location\");\n    $.each(worldmapLocations, function (index, object) {\n        var worldmapObject = $(\"#\" + object['id']);\n        var variableName = worldmapObject.attr('variableName');\n        var variableIndex = worldmapObject.attr('variableIndex');\n        var mapLocationObject = window[variableName][variableIndex];\n\n        var canvasCoordinates = getCanvasCoordinatesFromMapCoordinates(\n                mapLocationObject['location']['x'], mapLocationObject['location']['y']\n                );\n\n        // Change size, X and Y\n        worldmapObject.css({\n            'width': WORLDMAP_LOCATION_SIZE + 'px',\n            'height': WORLDMAP_LOCATION_SIZE + 'px',\n            'left': canvasCoordinates['canvasX'] - WORLDMAP_LOCATION_SIZE / 2,\n            'top': canvasCoordinates['canvasY'] - WORLDMAP_LOCATION_SIZE / 2,\n            'border-width': WORLDMAP_LOCATION_BORDER_WIDTH + 'px'\n        });\n    });\n\n    // Change css for all worldmap location labels\n    $(\".worldmap-location label\").css({\n        'margin-top': WORLDMAP_LOCATION_LABEL_MARGIN_TOP + 'px',\n        'margin-left': WORLDMAP_LOCATION_LABEL_MARGIN_LEFT + 'px',\n    });\n}\n\nfunction _recalculateZoom() {\n    _zoom = WORLDMAP_WIDTH / _currentWorldmapImageWidth;\n}\n\nfunction _changeZoomAndCheckIfAllowed(event, isZoomIn) {\n    var quantumOfChange = _zoomStep; //  * _worldmapZoomCurrentSpeed\n    if (isZoomIn) {\n        _currentWorldmapImageWidth -= _zoomStep;\n    } else {\n        _currentWorldmapImageWidth += _zoomStep;\n    }\n\n    // Recalculate zoom\n    _recalculateZoom();\n\n    // === Revert zoom if too close/far =========================================\n\n    var isZoomTooClose = _zoom < _MIN_ZOOM_VALUE; // Zoom is TOO BIG, background would be too pixel\n    var isZoomTooFar = _currentWorldmapImageWidth < WORLDMAP_CANVAS_WIDTH;\n    if (isZoomTooClose) {\n        worldmapMessage(\"Maximum zoom reached!\", \"#f35\");\n        _zoomMessageWasShown = true;\n        return false;\n    } else if (isZoomTooFar) {\n        worldmapMessage(\"Maximum zoom out reached!\", \"#2f3\");\n        _zoomMessageWasShown = true;\n        return false;\n    } else {\n        return true;\n    }\n}\n\nfunction _revertZoom() {\n    _currentWorldmapImageWidth = _oldMapImageWidth;\n    _zoom = _oldZoom;\n    _worldmapViewRectangle = _oldWorldmapViewRectangle;\n}\n","var WORLDMAP_WIDTH = 3500;\r\nvar WORLDMAP_HEIGHT = 3500;\r\n\r\n// =========================================================================\r\n\r\nwindow.initQueue.push(function () {\r\n    setTimeout(function () {\r\n\r\n        // =========================================================================\r\n        // Create canvas and define view rectangle\r\n        initializeWorldmap();\r\n        initializeWorldmapView();\r\n\r\n        // Initialize all canvas objects\r\n        initializeWorldmapLocations();\r\n\r\n        // Add all listeners\r\n        initializeWorldmapEvents();\r\n    }, 80);\r\n});\r\n\r\n// =========================================================================\r\n// =========================================================================\r\n// =========================================================================\r\n\r\nvar WORLDMAP_CANVAS_WIDTH = null;\r\nvar WORLDMAP_CANVAS_HEIGHT = null;\r\n\r\nvar WORLDMAP_CANVAS_MARGIN_LEFT = null;\r\nvar WORLDMAP_CANVAS_MARGIN_TOP = null;\r\n\r\nvar worldmap = null;\r\n\r\n// === Initialize ======================================================================\r\n\r\nfunction initializeWorldmap() {\r\n\r\n    // =========================================================================\r\n    // Define few layout related variables\r\n    WORLDMAP_CANVAS_WIDTH = $(\".worldmap\").width();\r\n    WORLDMAP_CANVAS_HEIGHT = $(\".content-wrapper\").height();\r\n\r\n    WORLDMAP_CANVAS_MARGIN_LEFT = $(\".sidebar\").width();\r\n    WORLDMAP_CANVAS_MARGIN_TOP = $(\".main-header\").height();\r\n//    console.log(\"INIT WORLDMAP\");\r\n//    console.log(\"WORLDMAP_CANVAS_WIDTH = \" + WORLDMAP_CANVAS_WIDTH);\r\n\r\n    // =========================================================================\r\n    var worldmap = $(\".worldmap\");\r\n    getWorldmap().css('background-image', 'url(\"/img/map/map.jpg\")');\r\n}\r\n\r\n// =========================================================================\r\n\r\nfunction getWorldmap() {\r\n    if (worldmap != null) {\r\n        return worldmap;\r\n    } else {\r\n        worldmap = $(\".worldmap\");\r\n        return worldmap;\r\n    }\r\n}"]}